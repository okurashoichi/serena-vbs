# Implementation Plan

## Task 1: Referenceデータモデルの実装

- [x] 1. シンボル参照を表現するデータクラスを実装する
  - VBScriptシンボル参照の位置情報とメタデータを保持する不変データクラスを作成
  - シンボル名、ファイルURI、行・列位置、定義/参照フラグ、コンテナ名を含む
  - 参照をLSPのLocation型に変換するメソッドを提供
  - _Requirements: 1.2, 3.3_

## Task 2: ReferenceTrackerの実装

- [x] 2. VBScriptコード内のシンボル参照を追跡・検索するコンポーネントを実装する

- [x] 2.1 (P) 参照抽出の基本機能を実装する
  - VBScriptファイル内容から識別子参照を正規表現ベースで抽出
  - コメント（' から行末まで）と文字列リテラル（"..."）内を除外するロジック
  - VBScriptの大文字小文字を区別しない言語特性に対応
  - 抽出した参照をドキュメントURIごとにインデックス化
  - _Requirements: 1.1, 1.4_

- [x] 2.2 (P) 参照インデックスの管理機能を実装する
  - URIベースと名前ベースの2種類のインデックスを維持
  - ドキュメント更新時に古い参照を削除して新しい参照で置換
  - ドキュメントクローズ時に該当URIの参照をすべて削除
  - _Requirements: 2.1, 5.1_

- [x] 2.3 参照検索機能を実装する
  - シンボル名に対する参照を大文字小文字を区別せずに検索
  - 宣言を含めるかどうかのオプション対応
  - 複数ファイルにまたがる参照を統合して返却
  - シンボルが存在しない場合は空リストを返却
  - _Requirements: 1.1, 1.3, 2.2_

## Task 3: SymbolIndexの拡張

- [x] 3. 既存のSymbolIndexをReferenceTrackerと統合する

- [x] 3.1 SymbolIndexの更新メソッドを拡張する
  - updateメソッドにcontentパラメータを追加
  - シンボル定義の更新後にReferenceTracker.updateを呼び出す
  - 既存のシンボルインデックス機能との互換性を維持
  - _Requirements: 5.1_

- [x] 3.2 find_referencesメソッドを実装変更する
  - 宣言のみを返す現在の実装を、実際の参照を返すように変更
  - ReferenceTrackerから参照を取得してLocation型に変換
  - include_declarationオプションを適切に処理
  - _Requirements: 1.1, 1.2, 2.2, 5.2_

## Task 4: VBScript LSPサーバーとの統合

- [x] 4. VBScript LSPサーバーでの参照追跡を有効化する

- [x] 4.1 ドキュメント変更時の参照追跡を有効化する
  - ドキュメント開封・変更イベントでSymbolIndex.updateにcontentを渡す
  - 参照追跡のログ出力を追加してデバッグを支援
  - _Requirements: 5.1, 5.3_

- [x] 4.2 textDocument/referencesリクエストの応答を検証する
  - LSPサーバーがfind_referencesを適切に呼び出していることを確認
  - 応答がLocation型のリストとして正しく返却されることを確認
  - _Requirements: 1.2, 2.2_

## Task 5: 単体テストの実装

- [x] 5. ReferenceTrackerとSymbolIndex拡張のテストを作成する

- [x] 5.1 (P) ReferenceTrackerの単体テストを作成する
  - 参照抽出の正確性テスト（関数呼び出し、変数参照、定数参照）
  - コメント・文字列内の除外テスト
  - 大文字小文字を区別しない検索のテスト
  - ドキュメント更新・削除時のインデックス整合性テスト
  - _Requirements: 1.1, 1.4_

- [x] 5.2 (P) SymbolIndex拡張の単体テストを作成する
  - find_referencesが実際の参照を返すことのテスト
  - include_declarationオプションのテスト
  - シンボルが存在しない場合の空リスト返却テスト
  - _Requirements: 1.3, 2.2_

## Task 6: 統合テストの実装

- [x] 6. VBScript LSPサーバーとSerenaツールの統合テストを作成する

- [x] 6.1 LSPサーバーレベルの統合テストを作成する
  - textDocument/referencesリクエストのエンドツーエンドテスト
  - 複数ファイルにまたがる参照検索のテスト
  - パースエラー時の部分結果返却テスト
  - _Requirements: 2.1, 2.2, 5.2_

- [x]* 6.2 既存FindReferencingSymbolsToolとの互換性テストを作成する
  - SerenaのMCPツール経由での参照検索が機能することを確認
  - 結果形式が既存のツールパターンに準拠していることを確認
  - エラーハンドリングが適切に動作することを確認
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

## 要件カバレッジ

| 要件ID | タスク | ステータス |
|--------|--------|----------|
| 1.1 | 2.1, 2.3, 3.2, 5.1 | カバー済み |
| 1.2 | 1, 3.2, 4.2 | カバー済み |
| 1.3 | 2.3, 5.2 | カバー済み |
| 1.4 | 2.1, 5.1 | カバー済み |
| 2.1 | 2.2, 6.1 | カバー済み |
| 2.2 | 2.3, 3.2, 4.2, 5.2, 6.1 | カバー済み |
| 2.3 | — | 将来対応（Non-Goals） |
| 3.1 | — | 既存実装（SolidLSP層） |
| 3.2 | — | 既存実装（SolidLSP層） |
| 3.3 | 1 | カバー済み |
| 4.1 | 6.2 | 既存実装＋テスト |
| 4.2 | 6.2 | 既存実装＋テスト |
| 4.3 | 6.2 | 既存実装＋テスト |
| 4.4 | 6.2 | 既存実装＋テスト |
| 5.1 | 2.2, 3.1, 4.1 | カバー済み |
| 5.2 | 3.2, 6.1 | カバー済み |
| 5.3 | 4.1 | カバー済み |

### 備考
- **2.3（インクルードファイル）**: Non-Goalsとして将来対応に分類
- **3.1, 3.2（コンテキスト提供）**: SolidLanguageServer.request_referencing_symbolsで既に実装済み
- **4.x（MCPツール統合）**: FindReferencingSymbolsToolが既存実装として存在、テストで検証
