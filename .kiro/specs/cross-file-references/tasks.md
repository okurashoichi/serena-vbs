# Implementation Plan: cross-file-references

## Tasks

- [x] 1. SymbolIndexにドキュメントコンテンツ管理機能を追加
- [x] 1.1 コンテンツ格納用の内部状態を追加
  - インデックス更新時にドキュメントコンテンツを保持する辞書を追加
  - URIをキー、コンテンツ文字列を値とするマッピングを管理
  - _Requirements: 1.1, 1.2_

- [x] 1.2 コンテンツ取得メソッドを実装
  - 指定URIに対応するドキュメントコンテンツを返却する機能を追加
  - 未インデックスのURIに対してはNoneを返却
  - _Requirements: 1.1, 1.2, 5.2_

- [x] 1.3 インデックス更新・削除時のコンテンツ管理を統合
  - シンボルインデックス更新時にコンテンツも同時に保存
  - ドキュメント削除時にコンテンツも同時に削除
  - 既存のシンボル管理ロジックとの一貫性を維持
  - _Requirements: 4.3_

- [x] 2. 参照検索ハンドラをプロジェクト全体検索に拡張
- [x] 2.1 インデックスからコンテンツを取得する方式に変更
  - ローカルドキュメントキャッシュへの依存を除去
  - シンボルインデックスからコンテンツを取得してシンボル名を抽出
  - 未インデックスURIの場合はnullを返却
  - _Requirements: 1.1, 1.2, 5.1, 5.2_

- [x] 2.2 エラーハンドリングとログ出力を強化
  - 内部例外発生時に適切なログを出力してnullを返却
  - シンボル未発見時のDEBUGログ出力
  - 予期しないエラーのERRORログ出力
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 3. クロスファイル参照検索のテスト
- [x] 3.1 SymbolIndexコンテンツ管理のユニットテスト
  - コンテンツ取得メソッドの正常系・異常系テスト
  - インデックス更新・削除時のコンテンツ管理テスト
  - 未インデックスURIに対するNone返却の確認
  - _Requirements: 1.1, 1.2, 5.2_

- [x] 3.2 (P) クロスファイル参照検索の統合テスト
  - 複数ファイルにまたがるシンボル参照の検索テスト
  - 未オープンファイルからの参照検索テスト
  - Include経由での参照検索テスト
  - 循環Includeを含むプロジェクトでの検索テスト
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3_

- [x] 3.3 (P) 参照結果一貫性のテスト
  - include_declaration=true/falseの動作確認
  - 大文字小文字を区別しない検索の確認
  - 重複参照が返却されないことの確認
  - _Requirements: 1.3, 3.1, 3.2, 3.3, 3.4_

- [x]* 3.4 (P) パフォーマンステスト
  - 大規模ファイル数での参照検索時間計測
  - 参照数が多いシンボルの検索時間確認
  - インデックス再構築が発生しないことの確認
  - _Requirements: 4.1, 4.2, 4.3_
