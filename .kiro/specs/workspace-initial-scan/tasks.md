# Implementation Plan: workspace-initial-scan

## Tasks

- [x] 1. 定数とヘルパーメソッドの追加
- [x] 1.1 (P) スキャン対象拡張子の判定機能を追加
  - VBScript関連ファイル（.vbs, .asp, .inc）を識別する機能を実装
  - 大文字・小文字を区別しない判定ロジック
  - _Requirements: 1.2_

- [x] 1.2 (P) 除外ディレクトリの判定機能を追加
  - .git, node_modules, Backup, bin, obj等の除外ディレクトリを識別
  - ドットで始まる隠しディレクトリを除外
  - _Requirements: 1.3, 1.4_

- [x] 2. ファイル読み込み機能の追加
- [x] 2.1 ファイル内容読み込み機能を実装
  - UTF-8エンコーディングでファイル内容を読み込み
  - エンコーディングエラー時はreplaceモードで継続
  - ファイルアクセスエラー（権限、存在しない等）時はNoneを返却
  - エラー発生時は警告ログを出力
  - _Requirements: 2.1, 2.3, 2.4_

- [x] 3. ワークスペーススキャン機能の実装
- [x] 3.1 ディレクトリ走査とファイル収集機能を実装
  - ワークスペースルートから再帰的にディレクトリを探索
  - 除外ディレクトリをスキップ
  - 対象拡張子のファイルのみを収集
  - 各ファイルの処理状況をDEBUGログで出力
  - _Requirements: 1.1, 1.3, 1.4, 3.3_

- [x] 3.2 ファイルパースとインデックス登録の統合
  - 収集したファイルの内容を読み込み
  - 既存の`_open_document()`を使用してインデックスに登録
  - パース成功時にシンボルがSymbolIndexに登録されることを確認
  - 個別ファイルのエラーでスキャン全体を停止しない
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 4. 完了通知とログ出力の実装
- [x] 4.1 スキャン完了通知機能を追加
  - `analysis_complete`イベント（threading.Event）を追加
  - スキャン完了時に`Found N source files`形式でINFOログを出力
  - 大規模プロジェクト（1000ファイル超）の場合は警告ログを出力
  - スキャン完了後に完了フラグをセット
  - _Requirements: 3.1, 3.2, 5.3_

- [x] 5. サーバー初期化への統合
- [x] 5.1 サーバー起動時のスキャン呼び出しを実装
  - `__init__`の終了前にワークスペーススキャンを実行
  - ワークスペースルートが指定されている場合のみスキャン実行
  - スキャン完了後にLSPリクエストの受付を開始
  - _Requirements: 1.1, 5.2_

- [x] 6. 既存機能との統合検証
- [x] 6.1 定義ジャンプ機能の統合テストを実装
  - 初期スキャンでインデックス化されたシンボルへのジャンプを検証
  - 未オープンファイルのシンボルが検索可能であることを確認
  - _Requirements: 4.1_

- [x] 6.2 参照検索機能の統合テストを実装
  - プロジェクト全体からの参照検索を検証
  - 複数ファイルにまたがる参照が見つかることを確認
  - _Requirements: 4.2_

- [x] 6.3 ファイルオープン時の更新動作を検証
  - 既にインデックス済みのファイルを開いた時の動作を確認
  - インデックスが最新の内容で更新されることを検証
  - _Requirements: 4.3_

- [x] 7. ユニットテストの追加
- [x] 7.1 (P) 拡張子判定のユニットテストを追加
  - .vbs, .VBS, .asp, .ASP, .inc, .INCの各パターンをテスト
  - 対象外拡張子（.txt, .js等）の除外を確認
  - _Requirements: 1.2_

- [x] 7.2 (P) 除外ディレクトリ判定のユニットテストを追加
  - .git, node_modules, Backup, bin, objの除外を確認
  - ドット始まりディレクトリの除外を確認
  - 通常ディレクトリ（src, lib等）が対象であることを確認
  - _Requirements: 1.3, 1.4_

- [x] 7.3 (P) ファイル読み込みのユニットテストを追加
  - 正常読み込みケースの検証
  - 存在しないファイルの処理を検証
  - エンコーディングエラーの処理を検証
  - _Requirements: 2.1, 2.3, 2.4_

- [x] 8. 統合テストの追加
- [x] 8.1 ワークスペーススキャンの統合テストを追加
  - 既存テストリポジトリ（5ファイル）でのスキャン動作確認
  - 空ディレクトリでのスキャン動作確認
  - ネストしたディレクトリ構造でのスキャン確認
  - 除外ディレクトリを含む構造でのスキャン確認
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 3.1, 3.2_

- [ ]* 8.2 パフォーマンス検証テストを追加
  - 100ファイル規模でのスキャン時間計測
  - 5秒以内の完了を検証
  - _Requirements: 5.1_

## Requirements Coverage

| Requirement | Tasks |
|-------------|-------|
| 1.1 | 3.1, 5.1 |
| 1.2 | 1.1, 7.1 |
| 1.3 | 1.2, 3.1, 7.2, 8.1 |
| 1.4 | 1.2, 3.1, 7.2, 8.1 |
| 2.1 | 2.1, 3.2, 7.3, 8.1 |
| 2.2 | 3.2, 8.1 |
| 2.3 | 2.1, 3.2, 7.3 |
| 2.4 | 2.1, 3.2, 7.3 |
| 3.1 | 4.1, 8.1 |
| 3.2 | 4.1, 8.1 |
| 3.3 | 3.1 |
| 4.1 | 6.1 |
| 4.2 | 6.2 |
| 4.3 | 6.3 |
| 5.1 | 8.2 |
| 5.2 | 5.1 |
| 5.3 | 4.1 |
