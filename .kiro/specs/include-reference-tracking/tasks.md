# Implementation Plan

## Tasks

- [x] 1. IncludeDirective データモデルの実装
- [x] 1.1 (P) インクルードディレクティブを表現するデータクラスを作成する
  - インクルード種別（file / virtual）、元パス、解決済みURI、位置情報を保持
  - 有効性フラグとエラーメッセージフィールドを含める
  - frozen=True で不変オブジェクトとして定義
  - _Requirements: 1.1, 1.2, 1.4_

- [x] 2. IncludeDirectiveParser の実装
- [x] 2.1 ASP インクルードディレクティブの正規表現パターンを定義する
  - `<!--#include file="...">` 形式の検出パターン
  - `<!--#include virtual="...">` 形式の検出パターン
  - 大文字小文字を区別しないマッチング
  - _Requirements: 1.1, 1.2_

- [x] 2.2 インクルードディレクティブの抽出メソッドを実装する
  - ASP コンテンツから全インクルードディレクティブを検出
  - 各ディレクティブの行番号・文字位置を計算
  - IncludeDirective オブジェクトのリストとして返却
  - _Requirements: 1.1, 1.2, 1.4_

- [x] 2.3 相対パスと仮想パスの解決ロジックを実装する
  - file 属性の場合、参照元ディレクトリを基準に絶対パスを計算
  - virtual 属性の場合、ワークスペースルートを基準に絶対パスを計算
  - パス解決失敗時は is_valid=False と error_message を設定
  - _Requirements: 1.2, 1.3_

- [x] 2.4 (P) IncludeDirectiveParser の単体テストを作成する
  - file / virtual 両形式の検出テスト
  - 相対パス・仮想パス解決のテスト
  - 位置情報の正確性検証
  - エラーケース（存在しないパス）のテスト
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [x] 3. IncludeEdge データモデルと IncludeGraph の基本構造
- [x] 3.1 (P) インクルード関係のエッジを表現するデータクラスを作成する
  - ソースURI、ターゲットURI、元のディレクティブ情報を保持
  - _Requirements: 2.1_

- [x] 3.2 インクルードグラフの基本データ構造を実装する
  - URI をキーとした隣接リスト（出力辺）の辞書
  - 逆方向の隣接リスト（入力辺）の辞書
  - グラフの初期化とクリアメソッド
  - _Requirements: 2.1_

- [x] 4. IncludeGraph のグラフ操作メソッド
- [x] 4.1 グラフの更新メソッドを実装する
  - 指定 URI の既存エッジを削除してから新規エッジを追加
  - 逆方向インデックスの同期更新
  - 影響を受けるファイル URI のリストを返却
  - _Requirements: 2.4, 6.3_

- [x] 4.2 グラフからのノード削除メソッドを実装する
  - 指定 URI の出力辺と入力辺を削除
  - インデックスの整合性を維持
  - 影響を受けるファイル URI のリストを返却
  - _Requirements: 6.2_

- [x] 4.3 直接インクルードファイルの取得メソッドを実装する
  - 指定 URI から直接参照しているファイルの URI リストを返却
  - 存在しない URI の場合は空リストを返却
  - _Requirements: 2.1_

- [x] 5. 推移的インクルードと循環検出
- [x] 5.1 推移的インクルード関係の計算メソッドを実装する
  - 深さ優先探索で到達可能な全ファイルを収集
  - 訪問済みノードを追跡して循環を検出
  - 依存順序でソートした URI リストを返却
  - _Requirements: 2.2_

- [x] 5.2 循環参照の検出と警告ロジックを実装する
  - 循環が検出された場合にログ出力（warning レベル）
  - 無限ループを防止して探索を打ち切り
  - has_cycle メソッドで循環有無を確認可能にする
  - _Requirements: 2.3_

- [x] 5.3 逆方向の参照取得メソッドを実装する
  - 指定 URI をインクルードしている全ファイルの URI リストを返却
  - Find References でインクルード元からの参照検索に使用
  - _Requirements: 4.1_

- [x] 5.4 (P) IncludeGraph の単体テストを作成する
  - グラフ更新・削除のテスト
  - 推移的インクルード計算のテスト
  - 循環参照検出のテスト
  - 逆方向参照取得のテスト
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 6. VBScriptLanguageServer へのインクルード機能統合
- [x] 6.1 サーバー初期化時に IncludeGraph と IncludeDirectiveParser を生成する
  - ワークスペースルートを IncludeDirectiveParser に渡す
  - IncludeGraph インスタンスをサーバーの状態として保持
  - _Requirements: 2.1_

- [x] 6.2 ドキュメントオープン時にインクルード解析を実行する
  - ASP ファイルの場合にインクルードディレクティブを抽出
  - IncludeGraph を更新
  - インクルード先ファイルが未読み込みの場合にファイルシステムから読み込み
  - _Requirements: 1.1, 1.2, 2.1, 6.1_

- [x] 6.3 ドキュメント変更時にインクルードグラフを更新する
  - 変更されたファイルのインクルード関係を再解析
  - グラフの該当エッジのみを更新
  - 影響を受けるファイルの再インデックス
  - _Requirements: 2.4, 6.3, 6.4_

- [x] 6.4 ドキュメントクローズ時にグラフから削除する
  - 該当ファイルをグラフから削除
  - 逆方向参照の更新
  - _Requirements: 6.2_

- [x] 7. インクルード経由の Go to Definition 拡張
- [x] 7.1 SymbolIndex にスコープ付き検索メソッドを追加する
  - 指定 URI リスト内のみでシンボル定義を検索
  - 既存の find_definition と互換性を維持
  - _Requirements: 3.1_

- [x] 7.2 goto_definition でインクルードファイル内のシンボルを検索する
  - ローカルファイルで定義が見つからない場合にインクルードグラフを参照
  - 推移的インクルード先の全ファイルを検索対象に追加
  - 複数の定義が見つかった場合は全てを Location リストで返却
  - _Requirements: 3.1, 3.2, 3.3, 3.4_

- [x] 8. インクルード経由の Find References 拡張
- [x] 8.1 find_references でインクルード元ファイルからの参照を検索する
  - インクルードグラフの逆方向参照を取得
  - インクルード元ファイル内の参照を収集
  - ローカル参照と統合して返却
  - _Requirements: 4.1, 4.2_

- [x] 8.2 include_declaration オプションの処理を確認する
  - true の場合は定義位置も結果に含める
  - 参照結果に URI と行・列位置を含める
  - _Requirements: 4.3, 4.4_

- [x] 9. Document Symbols でのインクルードシンボル表示
- [x] 9.1 インクルードディレクティブを SymbolKind.File として返却する
  - IncludeGraph からディレクティブ情報を取得
  - シンボル名にインクルード先ファイルパスを設定
  - パス解決失敗時はエラーマーカーを付与
  - _Requirements: 5.1, 5.2, 5.3_

- [x] 10. 統合テストの実装
- [x] 10.1 テスト用の複数 ASP ファイル構成を準備する
  - インクルード関係を持つ複数ファイル（A→B→C）
  - 循環参照を含むファイルセット
  - .inc ファイルを含む構成
  - _Requirements: 1.1, 2.1, 2.2, 2.3_

- [x] 10.2 インクルード経由の定義検索の統合テストを作成する
  - 直接インクルードファイルのシンボル検索
  - ネストしたインクルード経由のシンボル検索
  - 同名シンボルが複数ファイルに存在するケース
  - _Requirements: 3.1, 3.2, 3.3_

- [x] 10.3 インクルード経由の参照検索の統合テストを作成する
  - インクルードファイル内シンボルの参照検索
  - インクルード元と先の両方からの参照統合
  - include_declaration オプションの動作確認
  - _Requirements: 4.1, 4.2, 4.3, 4.4_

- [x] 10.4 ワークスペース変更時の動作確認テストを作成する
  - ファイル追加時のグラフ更新
  - ファイル削除時のグラフ更新
  - インクルードディレクティブ変更時の再計算
  - _Requirements: 6.1, 6.2, 6.3, 6.4_
